<!-- inheriting from the base file -->
{% extends 'books/base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">

    <!-- Filter and search bar -->
    <div class="mb-4">
        <form method="GET" action="">

            <!-- Search bar row -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="input-group">
                        <!-- Create a input box for input to use to search books or authors. If user enters a search value display that value when page updates to filter the search results -->
                        <input type="search" name="search" class="form-control" placeholder="Search by title or author..." {% if search %}value="{{ search }}"{% endif %}>
                        <button type="submit" class="btn btn-primary btn-sm">Search</button>
                    </div>
                </div>
            </div>

            <!-- Filters and sort row -->
            <div class="row g-2 align-items-end">

                <!-- Genre filter -->
                <div class="col-md-2">
                    <label class="form-label small text-muted">Genre</label>
                    <select name="genre" class="form-control">
                        <!-- Genre filter options. Display current selected filter if chosen by user -->
                        <option value="">All Genres</option>
                        <option value="fiction" {% if genre == "fiction" %}selected{% endif %}>Fiction</option>
                        <option value="nonfiction" {% if genre == "nonfiction" %}selected{% endif %}>Non-Fiction</option>
                        <option value="mystery" {% if genre == "mystery" %}selected{% endif %}>Mystery</option>
                        <option value="scifi" {% if genre == "scifi" %}selected{% endif %}>Science Fiction</option>
                        <option value="fantasy" {% if genre == "fantasy" %}selected{% endif %}>Fantasy</option>
                        <option value="thriller" {% if genre == "thriller" %}selected{% endif %}>Thriller</option>
                        <option value="romance" {% if genre == "romance" %}selected{% endif %}>Romance</option>
                        <option value="biography" {% if genre == "biography" %}selected{% endif %}>Biography</option>
                        <option value="history" {% if genre == "history" %}selected{% endif %}>History</option>
                        <option value="selfhelp" {% if genre == "selfhelp" %}selected{% endif %}>Self-Help</option>
                    </select>
                </div>

                <!-- Status filter -->
                <div class="col-md-2">
                    <label class="form-label small text-muted">Status</label>
                    <select name="status" class="form-control">
                        <!-- Status filter options. Display current selected filter if chosen by user -->
                        <option value="">All Statuses</option>
                        <option value="currently_reading" {% if status == "currently_reading" %}selected{% endif %}>Currently Reading</option>
                        <option value="want_to_read" {% if status == "want_to_read" %}selected{% endif %}>Want to Read</option>
                        <option value="finished" {% if status == "finished" %}selected{% endif %}>Finished</option>
                    </select>
                </div>

                <!-- Rating filter -->
                <div class="col-md-2">
                    <label class="form-label small text-muted">Rating</label>
                    <select name="rating" class="form-control">
                        <!-- Rating filter options. Display current selected filter if chosen by user -->
                        <option value="">All Ratings</option>
                        <option value="5" {% if rating == "5" %}selected{% endif %}>5 Stars</option>
                        <option value="4" {% if rating == "4" %}selected{% endif %}>4 Stars</option>
                        <option value="3" {% if rating == "3" %}selected{% endif %}>3 Stars</option>
                        <option value="2" {% if rating == "2" %}selected{% endif %}>2 Stars</option>
                        <option value="1" {% if rating == "1" %}selected{% endif %}>1 Star</option>
                    </select>
                </div>

                <!-- Year filter -->
                <div class="col-md-2">
                    <label class="form-label small text-muted">Year Finished</label>
                    <select name="year" class="form-control">
                        <!-- Display all years to filter by. Display current selected filtered year if chosen by user -->
                        <option value="">All Years</option>
                        {% for book_year in years %}
                        <!-- Display each year user has entered and use |stringformat:"s" to convert the year to a string to be compared to determine if selected or not -->
                        <option value="{{ book_year.year }}" {% if year == book_year.year|stringformat:"s" %}selected{% endif %}>
                            {{ book_year.year }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Sorting -->
                <div class="col-md-2">
                    <label class="form-label small text-muted">Sort By</label>
                    <!-- Create a dropdown for sorting options -->
                    <select name="sort" class="form-control">
                        <option value="title_asc" {% if sort == "title_asc" %}selected{% endif %}>Title: A to Z</option>
                        <option value="author_asc" {% if sort == "author_asc" %}selected{% endif %}>Author: A to Z</option>
                        <option value="rating_desc" {% if sort == "rating_desc" %}selected{% endif %}>Rating: High to Low</option>
                        <option value="rating_asc" {% if sort == "rating_asc" %}selected{% endif %}>Rating: Low to High</option>
                        <option value="date_desc" {% if sort == "date_desc" %}selected{% endif %}>Date: Newest First</option>
                        <option value="date_asc" {% if sort == "date_asc" %}selected{% endif %}>Date: Oldest First</option>
                    </select>
                </div>

                <!-- Button to apply the filters -->
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">Apply Filters</button>
                </div>

            </div>
        </form>
    </div>

    <!-- Book grid to display users books -->
    <div class="row">
        <!-- using a for loop to loop through all the books -->
        {% for book in books %}
        <div class="col-md-3">
            <div class="card my-2" style="height: 550px;">
                <a href="{% url 'book-detail' book.id %}">
                    <!-- this is the book image -->
                    {% if book.image %}
                    <img src="{{ book.image.url }}" class="card-img-top"
                        style="width:100%; height:auto; max-height:325px;" />
                    {% else %}
                    <!-- Display placeholder image if no book cover was uploaded -->
                    <img src="/static/images/placeholder.png" class="card-img-top" style="height:325px;" />
                    {% endif %}
                </a>
                <div class="card-body" style="display: flex; flex-direction: column; justify-content: space-between;">
                    <div>
                        <!-- Limits the title to 2 lines with ellipsis if it is too long using webkit-line-clamp -->
                        <h4 class="card-text"
                            style="overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical;">
                            {{ book.title }}
                        </h4>
                        <p class="text-muted"><small>by <u>{{ book.author }}</u></small></p>
                        <h5>{{ book.get_star_display }}</h5>
                    </div>
                    <a href="{% url 'book-detail' book.id %}" class="m-2 btn btn-outline-primary btn-sm">View Book</a>
                </div>
            </div>
        </div>
        <!-- If there are no books that match the filters display an alert letting the user know -->
        {% empty %}
        <div class="col-12">
            <div class="alert alert-info text-center" role="alert">
                <h5>No books found matching your filters</h5>
                <p>Try changing your filter options or <a href="{% url 'home' %}">clear all filters</a></p>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}