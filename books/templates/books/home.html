<!-- inheriting from the base file -->
{% extends 'books/base.html' %}
{% load static %}

{% block content %}
<div class="container mb-4">
    <div class="row">
        <!-- side navbar here -->
        <div class="col-md-3 mt-3">
            <div class="card">
                <h4 class="card-header px-3">Menu</h4>
                <ul class="list-group list-group-light list-group-small">
                    <li class="list-group-item px-3"><a href="{% url 'home' %}">Home</a></li>
                    <li class="list-group-item px-3"><a href="{% url 'statistics' %}">Statistics</a></li>
                    <li class="list-group-item px-3"><a href="{% url 'profile' %}">Profile</a></li>
                </ul>

                <!-- Form to filter in navbar using dropdowns-->
                <div class="p-3">
                    <form method="GET" action="">
                        <div class="mb-3">
                            <!-- Create a horizontal grouping for the search input -->
                            <div class="input-group">
                                <!-- Create a input box for input to use to search books or authors. If user enters a search value display that value when page updates to filter the search results -->
                                <input type="search" id="search" name="search" class="form-control"
                                    placeholder="Search Books" {% if search %} value="{{search}}" {% endif %}>
                                <button type="submit" class="btn btn-primary btn-sm">Search</button>
                            </div>
                        </div>
                        <h5 class="mb-3">Filter By</h5>
                        <label class="form-label font-weight-bold">Genre</label>
                        <select name="genre" class="form-control">
                            <!-- Genre filter options. Display current selected filter if chosen by user -->
                            <option value="">All Genres</option>
                            <option value="fiction" {% if genre == "fiction" %}selected{% endif %}>Fiction</option>
                            <option value="nonfiction" {% if genre == "nonfiction" %}selected{% endif %}>Non-Fiction
                            </option>
                            <option value="mystery" {% if genre == "mystery" %}selected{% endif %}>Mystery</option>
                            <option value="scifi" {% if genre == "scifi" %}selected{% endif %}>Science Fiction</option>
                            <option value="fantasy" {% if genre == "fantasy" %}selected{% endif %}>Fantasy</option>
                            <option value="thriller" {% if genre == "thriller" %}selected{% endif %}>Thriller</option>
                            <option value="romance" {% if genre == "romance" %}selected{% endif %}>Romance</option>
                            <option value="biography" {% if genre == "biography" %}selected{% endif %}>Biography</option>
                            <option value="history" {% if genre == "history" %}selected{% endif %}>History</option>
                            <option value="selfhelp" {% if genre == "selfhelp" %}selected{% endif %}>Self-Help</option>
                        </select>
                        <label class="form-label font-weight-bold mt-3">Rating</label>
                        <select name="rating" class="form-control">
                            <!-- Rating filter options. Display current selected filter if chosen by user -->
                            <option value="">All Ratings</option>
                            <option value="5" {% if rating == "5" %}selected{% endif %}>5 Stars</option>
                            <option value="4" {% if rating == "4" %}selected{% endif %}>4 Stars</option>
                            <option value="3" {% if rating == "3" %}selected{% endif %}>3 Stars</option>
                            <option value="2" {% if rating == "2" %}selected{% endif %}>2 Stars</option>
                            <option value="1" {% if rating == "1" %}selected{% endif %}>1 Star</option>
                        </select>
                        <label class="form-label font-weight-bold mt-3">Year Finished</label>
                        <select name="year" class="form-control">
                            <!-- Display all years to filter by. Display current selected filtered year if chosen by user -->
                            <option value="">All Years</option>
                            {% for book_year in years %}
                            <!-- Display each year user has entered and use |stringformat:"s" to convert the year to a string to be compared to determine if selected or not -->
                            <option value="{{ book_year.year }}" {% if year == book_year.year|stringformat:"s" %} selected{% endif %}>{{ book_year.year }}</option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-primary btn-sm mt-2 w-100">Apply</button>
                </div>
                <a href="{% url 'add-book' %}" class="m-2 btn btn-dark btn-sm">Add Book</a>
            </div>
        </div>
        <!-- books here -->
        <div class="col-md-9 mt-3">
            <div class="row">
                <!-- Create a container for the sort feature -->
                <div class="mb-3 d-flex justify-content-end align-items-center">
                    <p class="mb-0 me-2">Sort by:</p>
                    <!-- Create a dropdown for sorting options and use onchange to apply the selected sort option when it is picked -->
                    <select name="sort" class="form-select" style="width: auto;" onchange="this.form.submit()">
                        <option value="title_asc" {% if sort == "title_asc" %}selected{% endif %}>Title: A to Z</option>
                        <option value="author_asc" {% if sort == "author_asc" %}selected{% endif %}>Author: A to Z</option>
                        <option value="rating_desc" {% if sort == "rating_desc" %}selected{% endif %}>Rating: High to Low</option>
                        <option value="rating_asc" {% if sort == "rating_asc" %}selected{% endif %}>Rating: Low to High</option>
                        <option value="date_desc" {% if sort == "date_desc" %}selected{% endif %}>Date Finished: Newest to Oldest</option>
                        <option value="date_asc" {% if sort == "date_asc" %}selected{% endif %}>Date Finished: Oldest to Newest</option>
                    </select>
                </div>
                <!-- using a for loop to loop through all the books -->
                {% for book in books %}
                <div class="col-md-4">
                    <div class="card my-2" style="height: 550px;">
                        <a href="{% url 'book-detail' book.id %}">
                            <!-- this is the book image -->
                            {% if book.image %}
                            <img src="{{ book.image.url }}" class="card-img-top"
                                style="width:100%; height:auto; max-height:325px;" />
                            {% else %}
                            <!-- Display placeholder image if no book cover was uploaded -->
                            <img src="/static/images/placeholder.png" class="card-img-top" style="height:325px;" />
                            {% endif %}
                        </a>
                        <div class="card-body"
                            style="display: flex; flex-direction: column; justify-content: space-between;">
                            <div>
                                <!-- Limits the title to 2 lines with ellipsis if it is too long using webkit-line-clamp -->
                                <h4 class="card-text"
                                    style="overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical;">
                                    {{ book.title }}
                                </h4>
                                <p class="text-muted"><small>by <u>{{book.author}}</u></small></p>
                                <h5>{{book.get_star_display}}</h5>
                            </div>
                            <a href="{% url 'book-detail' book.id %}" class="m-2 btn btn-outline-dark btn-sm">View
                                Book</a>
                        </div>
                    </div>
                </div>
                <!-- If there are no books that match the filters display an alert letting the user know -->
                {% empty %}
                <div class="col-12">
                    <div class="alert alert-info text-center" role="alert">
                        <h5>No books found matching your filters</h5>
                        <p>Try changing your filter options or <a href="{% url 'home' %}">clear all filters</a></p>
                    </div>
                </div>
                {% endfor %}
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}